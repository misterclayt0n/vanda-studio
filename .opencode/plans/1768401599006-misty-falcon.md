# Full History & Gallery Feature

## Overview

Implement comprehensive history tracking and a gallery view so users can browse, access, and manage all their past generations. Currently, generated posts exist in the database but there's no UI to view history, and some data relationships have gaps.

---

## Current State Analysis

### What's Currently Saved

| Data Type | What's Saved | What's Missing |
|-----------|--------------|----------------|
| **Generated Posts** | caption, imagePrompt, model, imageModel, status, timestamps, brief settings | No direct userId (relies on projectId), standalone posts have no owner |
| **Generated Images** | storageId, model, aspectRatio, resolution, prompt, dimensions, createdAt | No generation duration, no cost, no "selected" flag |
| **Chat Messages** | Full conversation with snapshots, attachments, creditsUsed | Error messages not captured, no timing |
| **Image Edit Conversations** | userId, sourceImage, title, settings, turns with outputs | No error details, no duration/cost tracking |

### Current UI Routes

- `/` - Home page (lists projects, no history)
- `/posts/create` - Create new post (no access to past generations)
- `/posts/edit/[conversationId]` - Edit conversation page

### Key Gaps

1. **No Gallery/History UI** - Users can't browse past generations
2. **Orphaned data on delete** - chat_messages not cleaned up when post deleted
3. **No user-level history** - Standalone posts (no projectId) have no owner tracking
4. **Dual history systems** - Both `generation_history` (deprecated) and `chat_messages` exist

---

## Proposed Solution

### Phase 1: Data Model Fixes

1. **Add userId to generated_posts** - Direct user ownership for standalone posts
2. **Fix cascade deletes** - Clean up chat_messages when post is deleted
3. **Add deletedAt for soft deletes** - Preserve history, mark as deleted instead

### Phase 2: Gallery Page (`/gallery`)

A new page showing all user's generations:
- Grid of all generated images (from `generated_images` + `image_edit_outputs`)
- Filter by: date range, model, aspect ratio
- Sort by: newest, oldest
- Click to view full details and re-open for editing
- Download individual images or batch download

### Phase 3: Post Detail Page (`/posts/[postId]`)

View a specific generated post with:
- All generated image variants
- Caption with copy button
- Full chat history (if exists)
- Generation settings used
- Actions: Download, Refinar, Delete, Re-generate

### Phase 4: Edit Conversations Gallery (`/conversations`)

List all image editing conversations:
- Thumbnail of source image + latest output
- Title and turn count
- Last updated timestamp
- Click to continue conversation

---

## Schema Changes

```typescript
// Update generated_posts to add direct user ownership
generated_posts: defineTable({
    // ... existing fields ...
    userId: v.optional(v.id("users")), // NEW: Direct user ownership
    deletedAt: v.optional(v.number()), // NEW: Soft delete timestamp
})
.index("by_user_id", ["userId"])
.index("by_deleted", ["deletedAt"]),

// Update image_edit_conversations
image_edit_conversations: defineTable({
    // ... existing fields ...
    deletedAt: v.optional(v.number()), // NEW: Soft delete
})
```

---

## New Routes

| Route | Purpose |
|-------|---------|
| `/gallery` | Grid view of all generated images |
| `/posts/[postId]` | Detail view of a generated post |
| `/conversations` | List of all edit conversations |

---

## Implementation Order

1. **Schema updates** - Add userId, deletedAt fields
2. **Backend queries** - Add listByUser, getWithHistory queries
3. **Gallery page** - Basic grid with images
4. **Post detail page** - View individual post
5. **Conversations list** - Browse edit conversations
6. **Filters & search** - Date range, model filter
7. **Batch actions** - Multi-select download, delete

---

## User Decisions

- **Deletion**: Soft delete with trash (30-day restore window)
- **Gallery cards**: Image + caption preview (larger cards)
- **Search**: Full text search on prompts
- **Navigation**: Both sidebar nav item + quick access from create page

---

## Detailed Implementation Plan

### Phase 1: Schema Updates

**File: `src/convex/schema.ts`**

```typescript
// Add to generated_posts
userId: v.optional(v.id("users")),
deletedAt: v.optional(v.number()),
// Add indexes
.index("by_user_id", ["userId"])
.index("by_user_not_deleted", ["userId", "deletedAt"])

// Add to image_edit_conversations  
deletedAt: v.optional(v.number()),
// Add index
.index("by_user_not_deleted", ["userId", "deletedAt"])
```

### Phase 2: Backend Queries

**File: `src/convex/generatedPosts.ts`**

```typescript
// List all posts for current user (not deleted)
export const listByUser = query({...})

// Get post with all images and chat history
export const getWithHistory = query({...})

// Soft delete
export const softDelete = mutation({...})

// Restore from trash
export const restore = mutation({...})

// List deleted (trash)
export const listDeleted = query({...})

// Permanent delete (from trash)
export const permanentDelete = mutation({...})
```

**File: `src/convex/imageEditConversations.ts`**
- Add `softDelete`, `restore`, `listDeleted` mutations

**File: `src/convex/gallery.ts`** (NEW)
```typescript
// Unified gallery query - combines generated_images + image_edit_outputs
export const listAll = query({...})

// Search by prompt
export const search = query({...})
```

### Phase 3: Gallery Page

**File: `src/routes/gallery/+page.svelte`** (NEW)

Layout:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Logo] Gallery                          [Search...] [ğŸ”]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filters: [All â–¼] [Date â–¼] [Model â–¼] [Aspect â–¼]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚        â”‚
â”‚ â”‚  [img]  â”‚ â”‚  [img]  â”‚ â”‚  [img]  â”‚ â”‚  [img]  â”‚        â”‚
â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚        â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚ â”‚Caption  â”‚ â”‚Caption  â”‚ â”‚Caption  â”‚ â”‚Caption  â”‚        â”‚
â”‚ â”‚preview..â”‚ â”‚preview..â”‚ â”‚preview..â”‚ â”‚preview..â”‚        â”‚
â”‚ â”‚12/01/26 â”‚ â”‚12/01/26 â”‚ â”‚11/01/26 â”‚ â”‚11/01/26 â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” ...                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Features:
- Infinite scroll / pagination
- Click card â†’ opens detail modal or navigates to post page
- Hover shows quick actions (Download, Refinar, Delete)

### Phase 4: Post Detail Page

**File: `src/routes/posts/[postId]/+page.svelte`** (NEW)

Shows:
- All generated image variants in a grid
- Full caption with copy button
- Chat history timeline (if exists)
- Generation settings (model, aspect ratio, etc.)
- Actions: Download all, Refinar selected, Delete

### Phase 5: Navigation Updates

**File: `src/routes/+layout.svelte`** or create sidebar component

Add:
- "Galeria" nav item linking to `/gallery`
- "Conversas" nav item linking to `/conversations`

**File: `src/routes/posts/create/+page.svelte`**

Add:
- "Ver Historico" button in header that links to `/gallery`

### Phase 6: Trash Page

**File: `src/routes/gallery/trash/+page.svelte`** (NEW)

- Lists soft-deleted items
- Restore button on each item
- "Esvaziar Lixeira" to permanently delete all
- Auto-cleanup after 30 days (cron job or on-access cleanup)

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/convex/schema.ts` | MODIFY | Add userId, deletedAt fields |
| `src/convex/generatedPosts.ts` | MODIFY | Add listByUser, softDelete, restore |
| `src/convex/gallery.ts` | CREATE | Unified gallery queries |
| `src/convex/imageEditConversations.ts` | MODIFY | Add soft delete support |
| `src/routes/gallery/+page.svelte` | CREATE | Gallery page |
| `src/routes/gallery/trash/+page.svelte` | CREATE | Trash page |
| `src/routes/posts/[postId]/+page.svelte` | CREATE | Post detail page |
| `src/routes/conversations/+page.svelte` | CREATE | Conversations list |
| `src/lib/components/GalleryCard.svelte` | CREATE | Reusable gallery card |
| `src/routes/posts/create/+page.svelte` | MODIFY | Add history button |

---

## Verification

1. **Schema migration**: `bunx convex dev --once` succeeds
2. **Type check**: `bun run check` passes
3. **Gallery test flow**:
   - Generate a post â†’ appears in gallery
   - Click card â†’ see details
   - Delete â†’ goes to trash
   - Restore â†’ back in gallery
4. **Search test**: Search by prompt text returns correct results
5. **Navigation**: Gallery accessible from nav + create page

---

# Gallery Lightbox Feature

## Overview

Replace the full-page `/posts/[postId]` navigation with an immersive lightbox overlay that opens when clicking images in the gallery. Inspired by professional image editing tools.

## User Requirements

1. **Entry Point**: Gallery only - clicking an image opens lightbox (keep `/posts/[postId]` as fallback)
2. **Navigation**: Arrow keys + on-screen arrows to move between posts
3. **Outputs**: Show all images from the same post as thumbnails
4. **Thumbnail Click**: Switches the main view to that image

## Layout Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Ã—]                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚ SeeDream v4.5               â”‚
â”‚                                           â”‚ â± 28.5s  $ 0.0600  1536Ã—86  â”‚
â”‚           â†                    â†’          â”‚                             â”‚
â”‚                                           â”‚ "Change the text on the     â”‚
â”‚         [  LARGE IMAGE  ]                 â”‚  sign to say corgi co"      â”‚
â”‚                                           â”‚                             â”‚
â”‚                                           â”‚ 1/1/2026, 5:51:44 PM        â”‚
â”‚                                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚ All outputs (2)             â”‚
â”‚                                           â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”             â”‚
â”‚                                           â”‚ â”‚     â”‚ â”‚ âœ“   â”‚ â† selected  â”‚
â”‚                                           â”‚ â”‚img1 â”‚ â”‚img2 â”‚             â”‚
â”‚                                           â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                           â”‚ Nano Pro  SeeDream          â”‚
â”‚                                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚ Conversations (1)           â”‚
â”‚                                           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                           â”‚ â”‚ ğŸ’¬ Picture of a sea... â”‚  â”‚
â”‚                                           â”‚ â”‚ 3 turns Â· Created here â”‚  â”‚
â”‚                                           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚ [â¬‡ Download] [âœï¸ Refinar]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Structure

```
src/lib/components/lightbox/
â”œâ”€â”€ index.ts                      # Exports
â”œâ”€â”€ Lightbox.svelte               # Main orchestrator (overlay, keyboard, scroll lock)
â”œâ”€â”€ LightboxImage.svelte          # Left panel - large image + nav arrows
â”œâ”€â”€ LightboxSidebar.svelte        # Right panel - metadata, outputs, conversations
â”œâ”€â”€ LightboxThumbnail.svelte      # Reusable thumbnail component
â””â”€â”€ LightboxConversationCard.svelte # Conversation list item
```

## State Management

```typescript
// In gallery page
let lightboxOpen = $state(false);
let currentPostIndex = $state(0);        // Index in posts array
let currentImageIndex = $state(0);        // Index in post.images array

// Derived
let currentPost = $derived(posts[currentPostIndex]);
let currentImage = $derived(currentPost?.images?.[currentImageIndex]);

// URL sync (optional for shareability)
// ?view=postId&img=imageIndex
```

## Data Requirements

### Existing Queries (already available)
- `generatedPosts.listByUser` - Gallery posts with first image URL
- `generatedPosts.getWithHistory` - Full post with all images

### New Query Needed
```typescript
// src/convex/imageEditConversations.ts
export const listBySourceImage = query({
    args: { sourceImageId: v.id("generated_images") },
    handler: async (ctx, args) => {
        // Return conversations where sourceImageId matches
        // Include: title, turnCount, latestOutputUrl, createdAt
    }
});
```

## Implementation Steps

### Step 1: Create Lightbox Components
1. Create `src/lib/components/lightbox/` directory
2. Build `Lightbox.svelte` - overlay, keyboard handling, scroll lock
3. Build `LightboxImage.svelte` - image display with aspect ratio
4. Build `LightboxSidebar.svelte` - metadata, thumbnails, conversations
5. Build helper components (thumbnail, conversation card)
6. Export from `index.ts`

### Step 2: Add Backend Query
1. Add `listBySourceImage` query to `imageEditConversations.ts`
2. Deploy with `bunx convex dev --once`

### Step 3: Integrate in Gallery
1. Import lightbox components
2. Add state for lightbox open/close and current indices
3. Change card click handler to open lightbox instead of navigate
4. Wire up navigation (arrows, keyboard)
5. Handle URL parameters for shareable links (optional)

### Step 4: Wire Up Actions
1. Download button - same logic as current
2. Refinar button - opens EditImageModal, same as current
3. Conversation click - navigates to `/posts/edit/[conversationId]`

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/lib/components/lightbox/index.ts` | CREATE | Exports |
| `src/lib/components/lightbox/Lightbox.svelte` | CREATE | Main component |
| `src/lib/components/lightbox/LightboxImage.svelte` | CREATE | Image panel |
| `src/lib/components/lightbox/LightboxSidebar.svelte` | CREATE | Sidebar |
| `src/lib/components/lightbox/LightboxThumbnail.svelte` | CREATE | Thumbnail |
| `src/lib/components/lightbox/LightboxConversationCard.svelte` | CREATE | Conv card |
| `src/convex/imageEditConversations.ts` | MODIFY | Add listBySourceImage |
| `src/routes/gallery/+page.svelte` | MODIFY | Integrate lightbox |

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Escape` | Close lightbox |
| `â†` Arrow Left | Previous post |
| `â†’` Arrow Right | Next post |
| `1-9` (optional) | Switch to output 1-9 |

## Verification

1. **Type check**: `bun run check` passes
2. **Gallery flow**:
   - Click image â†’ lightbox opens
   - Arrow keys navigate between posts
   - Click thumbnail â†’ switches image
   - Click conversation â†’ navigates to edit page
   - Escape â†’ closes lightbox
3. **URL state** (if implemented):
   - Opening lightbox updates URL
   - Refresh page â†’ lightbox reopens at same image
   - Back button â†’ closes lightbox

---

# Composable Gallery: All Images as Posts

## Problem Statement

Currently, images generated through edit conversations (`image_edit_outputs`) are siloed in their own view and don't appear in the gallery. The user wants a **unified gallery** where every meaningful image output becomes a **post** that can be browsed, searched, and further edited.

**Core insight:** A post is fundamentally just **image(s) + caption**. Everything that enters the gallery should follow this pattern for maximum composability.

## Current Data Model

```
generated_posts (has caption)
    â””â”€â”€ generated_images (one per model, from initial generation)

image_edit_conversations (has title, no caption)
    â””â”€â”€ image_edit_turns
        â””â”€â”€ image_edit_outputs (orphaned from gallery!)
```

**The gap:** `image_edit_outputs` have no path to appear in the gallery because:
1. They don't belong to a `generated_post`
2. They don't have a caption (only the conversation title)

## Design Decision

**Each conversation output creates a new `generated_post`** that:
- Links to the output image via `generated_images`
- **Inherits the caption** from the original source post
- Appears in the gallery as a first-class citizen
- Can be further edited (creating more posts)

This creates a **lineage tree** of posts:

```
Original Post (caption: "Honey day post...")
    â””â”€â”€ generated_image A
        â””â”€â”€ Edit conversation â†’ Output 1 â†’ New Post (same caption)
            â””â”€â”€ generated_image B
                â””â”€â”€ Another edit â†’ Output 2 â†’ New Post (same caption)
```

## Schema Changes

### Option A: Create `generated_post` + `generated_image` for each output (Recommended)

When an `image_edit_output` is created, also create:
1. A new `generated_post` with:
   - `caption` inherited from the **original source post**
   - `status: "edited"`
   - `userId` from the conversation
   - `sourceConversationId` (new field) â†’ tracks lineage
   - `parentPostId` (new field) â†’ tracks lineage
2. A new `generated_image` linked to that post

**Schema additions to `generated_posts`:**
```typescript
// Lineage tracking
parentPostId: v.optional(v.id("generated_posts")),       // The post this was derived from
sourceConversationId: v.optional(v.id("image_edit_conversations")), // The conversation that created this
sourceOutputId: v.optional(v.id("image_edit_outputs")),  // The specific output
```

**Benefits:**
- Gallery query doesn't change
- All existing UI (lightbox, cards) works automatically
- Clear lineage tracking
- Each output can have its own caption if user edits it later

### Option B: Union query (Not recommended)

Create a gallery query that unions `generated_posts` and `image_edit_outputs`, normalizing them into the same shape. 

**Downsides:**
- Complex query logic
- Different schemas need normalization
- No caption for edit outputs without additional lookups
- Breaks composability (outputs can't be further edited without conversion)

## Implementation Plan

### Step 1: Update Schema

Add new fields to `generated_posts`:
```typescript
parentPostId: v.optional(v.id("generated_posts")),
sourceConversationId: v.optional(v.id("image_edit_conversations")),
sourceOutputId: v.optional(v.id("image_edit_outputs")),
```

Add new index:
```typescript
.index("by_source_output", ["sourceOutputId"])
```

### Step 2: Update `imageEditOutputs.create` Internal Mutation

After creating the output, also:
1. Trace back to get the original post's caption:
   ```
   output â†’ conversation â†’ sourceImageId â†’ generated_images â†’ generatedPostId â†’ generated_posts.caption
   ```
2. Create a new `generated_post` with inherited caption
3. Create a `generated_image` linked to the new post

### Step 3: Create Helper Function

```typescript
// src/convex/lib/createPostFromOutput.ts
export async function createPostFromOutput(
    ctx: MutationCtx,
    output: ImageEditOutput,
    conversation: ImageEditConversation,
    originalCaption: string,
    userId: Id<"users">
) {
    // Create post
    const postId = await ctx.db.insert("generated_posts", {
        userId,
        caption: originalCaption,
        status: "edited",
        sourceConversationId: conversation._id,
        sourceOutputId: output._id,
        parentPostId: /* trace back to original */,
        createdAt: Date.now(),
        updatedAt: Date.now(),
    });

    // Create generated_image linked to new post
    await ctx.db.insert("generated_images", {
        generatedPostId: postId,
        storageId: output.storageId,
        model: output.model,
        prompt: output.prompt,
        width: output.width,
        height: output.height,
        aspectRatio: conversation.aspectRatio,
        resolution: conversation.resolution,
        createdAt: Date.now(),
    });

    return postId;
}
```

### Step 4: Update `ai/imageEdit.ts` Actions

In both `startConversation` and `sendEdit` actions, after creating each output, call the helper to create the corresponding post.

### Step 5: Backfill Existing Outputs (Optional Migration)

Create a migration script to convert existing `image_edit_outputs` into posts:
```typescript
export const backfillOutputsAsPosts = internalMutation({...})
```

## Files to Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/convex/schema.ts` | MODIFY | Add lineage fields to `generated_posts` |
| `src/convex/imageEditOutputs.ts` | MODIFY | Create post+image when output is created |
| `src/convex/ai/imageEdit.ts` | MODIFY | Pass necessary data for post creation |
| `src/convex/lib/createPostFromOutput.ts` | CREATE | Helper function for creating posts from outputs |

## UX Implications

1. **Gallery shows all images** - Original generations AND edit outputs
2. **Clicking an edited image** - Opens lightbox, shows inherited caption
3. **Further editing** - Works seamlessly, creates another post in the lineage
4. **Lineage visible** - Could show "Derived from [parent post]" in sidebar

## Verification

1. **Schema migration**: `bunx convex dev --once` succeeds
2. **Type check**: `bun run check` passes
3. **Test flow**:
   - Create a post with initial images
   - Start edit conversation, make edits
   - Go to gallery â†’ edited images appear as new cards
   - Click edited image â†’ lightbox shows original caption
   - Click "Nova conversa" on edited image â†’ can edit further
   - All images maintain lineage back to original

---

# Lightbox Sidebar Improvements

## Overview

Two improvements to the lightbox sidebar:

1. **Replace "Prompt" section with "Legenda" (Caption)** - Show the post caption with hashtags instead of the image generation prompt
2. **Always show "Nova conversa" button** - Allow starting a new conversation from any image, not just when there are no existing conversations

## Current State

In `LightboxSidebar.svelte`:
- Lines 179-187: Shows "Prompt" section with `currentImage.prompt` (the image generation prompt)
- Lines 242-268: Shows "Iniciar conversa" button only when `conversations.length === 0`

## Required Changes

### Change 1: Replace Prompt with Caption

**Before:**
```svelte
<!-- Prompt -->
{#if currentImage?.prompt}
    <div class="mt-6">
        <h3 class="text-sm font-medium text-foreground">Prompt</h3>
        <p class="mt-2 text-sm leading-relaxed text-muted-foreground">
            {truncatePrompt(currentImage.prompt)}
        </p>
    </div>
{/if}
```

**After:**
```svelte
<!-- Caption (Legenda) -->
{#if post.caption}
    <div class="mt-6">
        <h3 class="text-sm font-medium text-foreground">Legenda</h3>
        <p class="mt-2 text-sm leading-relaxed text-muted-foreground whitespace-pre-wrap">
            {post.caption}
        </p>
    </div>
{/if}
```

Notes:
- Use `post.caption` instead of `currentImage?.prompt`
- Add `whitespace-pre-wrap` to preserve line breaks and hashtag formatting
- Remove the `truncatePrompt` function call - show full caption
- The caption includes hashtags already

### Change 2: Always Show "Nova conversa" Button

**Before:**
```svelte
{:else}
    <p class="mt-3 text-sm text-muted-foreground">
        Nenhuma conversa de edicao ainda
    </p>
    <Button
        variant="outline"
        size="sm"
        class="mt-2 w-full"
        onclick={onrefine}
    >
        ...
        Iniciar conversa
    </Button>
{/if}
```

**After:**
```svelte
{:else}
    <p class="mt-3 text-sm text-muted-foreground">
        Nenhuma conversa de edicao ainda
    </p>
{/if}

<!-- Always show button to start new conversation -->
<Button
    variant="outline"
    size="sm"
    class="mt-3 w-full"
    onclick={onrefine}
>
    <svg ...>
        <path ... d="M12 4.5v15m7.5-7.5h-15" />
    </svg>
    Nova conversa
</Button>
```

Notes:
- Move the button outside the `{:else}` block
- Change text from "Iniciar conversa" to "Nova conversa"
- The button should always appear, whether there are existing conversations or not
- This allows users to start multiple independent conversations from the same image

## Files to Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/lib/components/lightbox/LightboxSidebar.svelte` | MODIFY | Replace prompt with caption, always show new conversation button |

## Verification

1. **Type check**: `bun run check` passes
2. **Test flow**:
   - Open lightbox â†’ should show "Legenda" section with caption + hashtags (not the prompt)
   - Should always see "Nova conversa" button
   - Click "Nova conversa" â†’ opens EditImageModal
   - If conversations exist, they should still be listed above the button

---

# Image Editing Conversations Feature

## Overview

Allow users to start a conversation from any generated image, iteratively edit it with natural language prompts, and generate new images across multiple turns. Each turn can use multiple models, and the conversation history is fully persisted.

---

## User Flow

### 1. Entry Point
- **Edit button** appears on hover over each generated image thumbnail
- Clicking opens the **Start Editing Modal**

### 2. Start Editing Modal (new conversation)
- Shows source image with model name + dimensions
- **Model selector** (multi-select) - defaults to source image's model but user can choose any
- **Text input** for describing the edit
- **Add references** button for additional reference images
- **"Start Editing" button** â†’ creates conversation, navigates to `/posts/edit/[conversationId]`

### 3. Conversation Page
- **Header**: Back button (â† Gallery), title (auto-generated from first prompt), turn count
- **Thumbnail strip**: Horizontal scroll of ALL images in conversation
- **Main area**: Conversation turns, each showing:
  - User message
  - Generated images (one per model, with loading skeletons for pending)
- **Input area**: Model selector + textarea + references button + send button
- **Progressive loading**: Images appear as they complete (subscription-based)

### 4. Reference Image Behavior
- **Automatic**: Previous turn's output images automatically become references for next turn
- **Manual additions**: User can add extra reference images per turn

---

## Schema Design

### New Tables

```typescript
// Image edit conversations
image_edit_conversations: defineTable({
    // Owner (can be any user who starts the conversation)
    userId: v.id("users"),
    
    // Source image that started this conversation
    sourceImageId: v.id("generated_images"),
    sourceStorageId: v.id("_storage"), // Denormalized for quick access
    
    // Metadata
    title: v.string(), // Auto-generated from first prompt
    
    // Settings (defaults for new turns)
    aspectRatio: v.string(), // Inherited from source
    resolution: v.string(),  // Inherited from source
    
    // Timestamps
    createdAt: v.number(),
    updatedAt: v.number(),
}).index("by_user_id", ["userId"])
  .index("by_source_image", ["sourceImageId"]),

// Each turn in a conversation
image_edit_turns: defineTable({
    conversationId: v.id("image_edit_conversations"),
    turnIndex: v.number(), // 0, 1, 2, ...
    
    // User input
    userMessage: v.string(),
    selectedModels: v.array(v.string()), // Models chosen for this turn
    
    // Additional reference images (user-uploaded)
    manualReferenceIds: v.optional(v.array(v.id("_storage"))),
    
    // Generation state (for progressive loading)
    status: v.string(), // "pending" | "generating" | "completed" | "error"
    pendingModels: v.optional(v.array(v.string())), // Models still generating
    
    createdAt: v.number(),
}).index("by_conversation", ["conversationId"])
  .index("by_conversation_turn", ["conversationId", "turnIndex"]),

// Output images for each turn (one per model)
image_edit_outputs: defineTable({
    turnId: v.id("image_edit_turns"),
    conversationId: v.id("image_edit_conversations"), // Denormalized for queries
    
    // Image data
    storageId: v.id("_storage"),
    model: v.string(),
    prompt: v.string(), // The prompt used
    width: v.number(),
    height: v.number(),
    
    createdAt: v.number(),
}).index("by_turn", ["turnId"])
  .index("by_conversation", ["conversationId"]),
```

---

## Backend Implementation

### File Structure

```
src/convex/
  imageEditConversations.ts  # Conversation CRUD
  imageEditTurns.ts          # Turn CRUD + progressive loading mutations
  imageEditOutputs.ts        # Output image queries
  ai/
    imageEdit.ts             # Actions: startConversation, sendEdit
```

### 1. `imageEditConversations.ts`

```typescript
// Queries
get(id)                    // Get single conversation with source image URL
listByUser()               // List all conversations for current user
getBySourceImage(imageId)  // Check if conversation exists for an image

// Mutations
create({ sourceImageId, title, aspectRatio, resolution })
updateTitle({ id, title })
remove({ id })             // Delete conversation + all turns + outputs
```

### 2. `imageEditTurns.ts`

```typescript
// Queries
listByConversation(conversationId)  // Get all turns with their outputs

// Mutations (public)
// None - turns are created by actions

// Internal Mutations (for actions)
internal.create({ conversationId, turnIndex, userMessage, selectedModels, manualReferenceIds })
internal.updateStatus({ id, status, pendingModels })
internal.removeFromPending({ id, model })  // Progressive loading
```

### 3. `imageEditOutputs.ts`

```typescript
// Queries
listByTurn(turnId)                  // Get outputs for a turn (with URLs)
listByConversation(conversationId)  // Get all outputs (for thumbnail strip)

// Internal Mutations
internal.create({ turnId, conversationId, storageId, model, prompt, width, height })
```

### 4. `ai/imageEdit.ts` (Actions)

#### `startConversation`

```typescript
export const startConversation = action({
    args: {
        sourceImageId: v.id("generated_images"),
        userMessage: v.string(),
        selectedModels: v.array(v.string()),
        manualReferenceIds: v.optional(v.array(v.id("_storage"))),
    },
    handler: async (ctx, args) => {
        // 1. Auth check
        // 2. Get source image data
        // 3. Create conversation with auto-generated title
        // 4. Create turn 0 with status "generating"
        // 5. Get source image URL as reference
        // 6. Generate images in parallel (one per model)
        //    - Each completion: save output, remove from pendingModels
        // 7. Mark turn as "completed"
        // 8. Return conversationId
    },
});
```

#### `sendEdit`

```typescript
export const sendEdit = action({
    args: {
        conversationId: v.id("image_edit_conversations"),
        userMessage: v.string(),
        selectedModels: v.array(v.string()),
        manualReferenceIds: v.optional(v.array(v.id("_storage"))),
    },
    handler: async (ctx, args) => {
        // 1. Auth check
        // 2. Get conversation
        // 3. Get previous turn's outputs (auto-references)
        // 4. Create new turn with next turnIndex
        // 5. Build reference URLs: previous outputs + manual references
        // 6. Generate images in parallel
        // 7. Mark turn as "completed"
        // 8. Update conversation.updatedAt
    },
});
```

**Key: Progressive Loading Pattern** (same as current post creation)

```typescript
await Promise.all(
    selectedModels.map(async (model) => {
        try {
            const result = await generateImage({
                caption: "", // Not needed for edits
                instructions: userMessage,
                referenceImageUrls,
                model,
                aspectRatio,
                resolution,
            });
            
            // Store image
            const storageId = await ctx.storage.store(blob);
            
            // Save output (triggers subscription)
            await ctx.runMutation(internal.imageEditOutputs.create, {...});
            
            // Remove from pending (triggers subscription)
            await ctx.runMutation(internal.imageEditTurns.removeFromPending, {
                id: turnId,
                model,
            });
        } catch (err) {
            // Still remove from pending on failure
            await ctx.runMutation(internal.imageEditTurns.removeFromPending, {...});
        }
    })
);
```

---

## Frontend Implementation

### File Structure

```
src/lib/components/studio/
  EditImageModal.svelte       # Modal to start new conversation
  TurnCard.svelte             # Single turn display
  ConversationHeader.svelte   # Header with back button, title, turn count

src/routes/posts/edit/
  [conversationId]/
    +page.svelte              # Main conversation page
```

### 1. Edit Button on Image Thumbnails

Add to `/posts/create/+page.svelte` in the thumbnail rendering:

```svelte
<button
    onclick={() => openEditModal(image)}
    class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 ..."
>
    Edit
</button>
```

### 2. `EditImageModal.svelte`

**Props:**
```typescript
interface Props {
    image: GeneratedImage; // Source image to edit
    open: boolean;
    onclose: () => void;
}
```

**Layout (matching reference Image 1):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† New Conversation                                   â”‚
â”‚   Start editing this image                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    What would you like to change? â”‚
â”‚  â”‚              â”‚    Describe the edit you want...   â”‚
â”‚  â”‚   [IMAGE]    â”‚                                    â”‚
â”‚  â”‚              â”‚    [Models â–¼] [Model] Ã— [Model] Ã—  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚   Model Name                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   1024 x 1024                â”‚ Your instructions  â”‚  â”‚
â”‚                              â”‚                    â”‚  â”‚
â”‚                              â”‚ ğŸ“ Add references  â”‚  â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â”‚                     [Cmd + Enter to send]  [â–¶ Start] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**State:**
```typescript
let selectedModels = $state([props.image.model]); // Default to source model
let editPrompt = $state("");
let referenceImages = $state<File[]>([]);
let isStarting = $state(false);
```

**On Submit:**
```typescript
async function handleStart() {
    isStarting = true;
    const result = await client.action(api.ai.imageEdit.startConversation, {
        sourceImageId: image._id,
        userMessage: editPrompt,
        selectedModels,
        ...(referenceStorageIds.length && { manualReferenceIds: referenceStorageIds }),
    });
    goto(`/posts/edit/${result.conversationId}`);
}
```

### 3. Conversation Page (`/posts/edit/[conversationId]/+page.svelte`)

**Layout (matching reference Image 2):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Gallery â”‚ Conversation Title              2 turns â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [img1] [img2] [img3] [img4] ...     (thumbnail strip)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ â— EDIT 1                                             â”‚
â”‚   Replace the sea lion with a corgi                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚     â”‚ â”‚ â—‹   â”‚ â† loading skeleton                â”‚
â”‚   â”‚img1 â”‚ â”‚Gen..â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚   SeeDream                                           â”‚
â”‚                                                      â”‚
â”‚ â— EDIT 2                                             â”‚
â”‚   Make the background sunset                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚     â”‚ â”‚     â”‚ â”‚     â”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Models â–¼] [Nano Pro Ã—] [SeeDream Ã—]                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Describe your edit...                          â”‚  â”‚
â”‚ â”‚ ğŸ“ References                                  â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              [Cmd+Enter]      [â–¶]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Subscriptions:**
```typescript
// URL param
const conversationId = $derived($page.params.conversationId as Id<"image_edit_conversations">);

// Conversation metadata
const conversationQuery = useQuery(
    api.imageEditConversations.get,
    () => conversationId ? { id: conversationId } : "skip"
);

// All turns with their outputs
const turnsQuery = useQuery(
    api.imageEditTurns.listByConversation,
    () => conversationId ? { conversationId } : "skip"
);

// All outputs for thumbnail strip
const allOutputsQuery = useQuery(
    api.imageEditOutputs.listByConversation,
    () => conversationId ? { conversationId } : "skip"
);
```

**State:**
```typescript
let selectedModels = $state<string[]>(["google/gemini-3-pro-image-preview"]);
let editPrompt = $state("");
let referenceFiles = $state<File[]>([]);
let isSending = $state(false);
```

**Send Edit:**
```typescript
async function handleSendEdit() {
    if (!editPrompt.trim()) return;
    isSending = true;
    
    // Upload manual references if any
    const manualReferenceIds = await uploadReferences(referenceFiles);
    
    await client.action(api.ai.imageEdit.sendEdit, {
        conversationId,
        userMessage: editPrompt,
        selectedModels,
        ...(manualReferenceIds.length && { manualReferenceIds }),
    });
    
    editPrompt = "";
    referenceFiles = [];
    isSending = false;
}
```

### 4. `TurnCard.svelte`

**Props:**
```typescript
interface Props {
    turn: Turn;
    outputs: Output[];
    turnNumber: number; // 1-indexed for display
}
```

**Template:**
```svelte
<div class="space-y-3">
    <div class="flex items-center gap-2">
        <div class="h-2 w-2 rounded-full bg-primary"></div>
        <span class="text-xs text-muted-foreground">EDIT {turnNumber}</span>
    </div>
    <p class="text-sm">{turn.userMessage}</p>
    <div class="flex gap-3 flex-wrap">
        {#each outputs as output}
            <ImageThumbnail {output} />
        {/each}
        {#each turn.pendingModels ?? [] as model}
            <ImageSkeleton {model} size="thumbnail" />
        {/each}
    </div>
</div>
```

---

## Implementation Order

### Phase 1: Schema & Backend CRUD
1. Add new tables to `schema.ts`
2. Create `imageEditConversations.ts` with queries/mutations
3. Create `imageEditTurns.ts` with queries/mutations
4. Create `imageEditOutputs.ts` with queries/mutations
5. Run `bunx convex dev --once` to deploy

### Phase 2: Backend Actions
1. Create `ai/imageEdit.ts` with `startConversation` action
2. Add `sendEdit` action
3. Test with Convex dashboard

### Phase 3: Frontend Modal
1. Create `EditImageModal.svelte`
2. Add Edit button to image thumbnails in create page
3. Wire up modal open/close + navigation

### Phase 4: Conversation Page
1. Create route structure `/posts/edit/[conversationId]/`
2. Implement subscriptions and basic layout
3. Add `TurnCard.svelte` component
4. Implement send edit flow

### Phase 5: Polish
1. Add thumbnail strip for all conversation images
2. Handle errors and loading states
3. Add keyboard shortcut (Cmd+Enter to send)

---

## Files to Create/Modify

### New Files
| File | Purpose |
|------|---------|
| `src/convex/imageEditConversations.ts` | Conversation CRUD |
| `src/convex/imageEditTurns.ts` | Turn CRUD + progressive loading |
| `src/convex/imageEditOutputs.ts` | Output queries |
| `src/convex/ai/imageEdit.ts` | Generation actions |
| `src/lib/components/studio/EditImageModal.svelte` | Start conversation modal |
| `src/lib/components/studio/TurnCard.svelte` | Turn display component |
| `src/routes/posts/edit/[conversationId]/+page.svelte` | Conversation page |

### Modified Files
| File | Changes |
|------|---------|
| `src/convex/schema.ts` | Add 3 new tables |
| `src/routes/posts/create/+page.svelte` | Add Edit button on thumbnails |
| `src/lib/components/studio/index.ts` | Export new components |

---

## Verification

1. **Schema**: `bunx convex dev --once` - no errors
2. **Type Check**: `bun run check` - passes
3. **E2E Test Flow**:
   - Generate a post with images
   - Click Edit on a thumbnail â†’ modal opens
   - Enter edit prompt, select models, click Start
   - Redirected to conversation page
   - See turn 1 with loading skeletons â†’ images appear progressively
   - Send another edit â†’ turn 2 appears with progressive loading
   - Refresh page â†’ conversation history persists
   - Back button returns to create page

---

# ARCHIVED: Progressive Loading UI (Previous Plan)

The following was the previous plan for progressive loading, which has been implemented.

---

# Progressive Loading UI with Convex Subscriptions

## Goal

Replace the "all-at-once" loading with progressive UI updates:
1. **Caption loads first** â†’ show it immediately
2. **First image loads** â†’ mount the full results UI  
3. **Remaining images** â†’ show loading skeletons that fill in progressively
4. **Tooltip on loading skeletons** â†’ "Nao se preocupe, isso leva alguns segundos"

## Architecture

### Current Flow (synchronous)
```
Frontend calls action â†’ waits 30-60s â†’ gets all results at once
```

### New Flow (progressive with subscriptions)
```
Frontend calls action â†’ gets generatedPostId immediately
Frontend subscribes to:
  - generatedPosts.get(id) â†’ caption updates in real-time
  - generatedImages.listByPost(id) â†’ images appear as they complete
Backend updates DB progressively â†’ subscriptions push updates to frontend
```

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/convex/schema.ts` | Add `pendingImageModels`, `totalImageModels` fields to `generated_posts` |
| `src/convex/generatedPosts.ts` | Add `removeFromPending` mutation, update `create` mutation args |
| `src/convex/ai/chat.ts` | Restructure to update DB progressively during generation |
| `src/routes/posts/create/+page.svelte` | Use `useQuery` subscriptions instead of waiting for action |
| `src/lib/components/studio/ImageSkeleton.svelte` | **NEW** - Loading skeleton with tooltip |

---

## Implementation Details

### 1. Update Schema (`src/convex/schema.ts`)

Add to `generated_posts` table definition (around line 62-98):

```typescript
// Add these fields after line 81 (after status field):
pendingImageModels: v.optional(v.array(v.string())), // Models still generating
totalImageModels: v.optional(v.number()), // Total models requested
```

### 2. Update `generatedPosts.ts` 

#### 2a. Update `create` mutation args (line 120-143)

Add new args:
```typescript
pendingImageModels: v.optional(v.array(v.string())),
totalImageModels: v.optional(v.number()),
```

Add to insert:
```typescript
...(args.pendingImageModels && { pendingImageModels: args.pendingImageModels }),
...(args.totalImageModels && { totalImageModels: args.totalImageModels }),
```

#### 2b. Add new `removeFromPending` mutation (after `updateFromChat`)

```typescript
// Remove a model from pending list (called when image generation completes)
export const removeFromPending = mutation({
    args: {
        id: v.id("generated_posts"),
        model: v.string(),
    },
    handler: async (ctx, args) => {
        const identity = await ctx.auth.getUserIdentity();
        if (!identity) {
            throw new Error("Not authenticated");
        }

        const post = await ctx.db.get(args.id);
        if (!post) return;
        
        const pending = post.pendingImageModels?.filter(m => m !== args.model) ?? [];
        await ctx.db.patch(args.id, { 
            pendingImageModels: pending,
            updatedAt: Date.now(),
        });
    },
});
```

#### 2c. Update `updateFromChat` mutation to support clearing `pendingImageModels`

Add to args:
```typescript
pendingImageModels: v.optional(v.array(v.string())),
totalImageModels: v.optional(v.number()),
```

Add to patch:
```typescript
...(args.pendingImageModels !== undefined && { pendingImageModels: args.pendingImageModels }),
...(args.totalImageModels !== undefined && { totalImageModels: args.totalImageModels }),
```

### 3. Restructure `generate` Action (`src/convex/ai/chat.ts`)

Key changes:
1. Create post immediately with `status: "generating_caption"` and `pendingImageModels`
2. Update caption to DB BEFORE starting image generation
3. Each image saves individually (already does this)
4. Remove from `pendingImageModels` as each completes
5. Return `generatedPostId` at the end (action still runs to completion, but subscriptions provide live updates)

```typescript
export const generate = action({
    // ... existing args
    handler: async (ctx, args): Promise<{
        success: boolean;
        generatedPostId: Id<"generated_posts">;
    }> => {
        // 1. Auth check (existing)
        
        // 2. Verify project access (existing)
        
        // 3. Parse studio settings (existing)
        const imageModels = args.imageModels ?? [DEFAULT_IMAGE_MODEL];
        
        // 4. Create post with progressive state
        const generatedPostId = await ctx.runMutation(api.generatedPosts.create, {
            ...(args.projectId && { projectId: args.projectId }),
            caption: "", // Will be updated
            status: "generating_caption",
            pendingImageModels: imageModels,
            totalImageModels: imageModels.length,
        });

        // 5. Save user message (existing)

        // 6. Generate caption
        const captionResult = await generateCaption({...});
        
        // 7. Update post with caption, change status to "generating_images"
        await ctx.runMutation(api.generatedPosts.updateFromChat, {
            id: generatedPostId,
            caption: captionResult.caption,
            model: MODELS.GPT_4_1,
            status: "generating_images",
        });

        // 8. Collect reference images (existing)

        // 9. Generate images in parallel
        await Promise.all(
            imageModels.map(async (model) => {
                try {
                    const imageResult = await generateImage({...});
                    
                    // Store and save to DB (existing logic)
                    const storageId = await ctx.storage.store(blob);
                    await ctx.runMutation(api.generatedImages.create, {...});
                    
                    // Remove from pending
                    await ctx.runMutation(api.generatedPosts.removeFromPending, {
                        id: generatedPostId,
                        model,
                    });
                } catch (err) {
                    console.error(`Image generation failed for ${model}:`, err);
                    // Still remove from pending on failure
                    await ctx.runMutation(api.generatedPosts.removeFromPending, {
                        id: generatedPostId,
                        model,
                    });
                }
            })
        );

        // 10. Get results for primary image (for backward compatibility)
        const allImages = await ctx.runQuery(api.generatedImages.listByPost, {
            generatedPostId,
        });
        const primaryImage = allImages[0];

        // 11. Mark as completed with final state
        await ctx.runMutation(api.generatedPosts.updateFromChat, {
            id: generatedPostId,
            ...(primaryImage && { imageStorageId: primaryImage.storageId }),
            ...(primaryImage && { imagePrompt: primaryImage.prompt }),
            ...(primaryImage && { imageModel: primaryImage.model }),
            status: "generated",
            pendingImageModels: [], // Clear pending
        });

        // 12. Save assistant message (existing)

        return {
            success: true,
            generatedPostId,
        };
    },
});
```

### 4. Frontend Progressive UI (`+page.svelte`)

#### 4a. Update imports and state

```typescript
import { useConvexClient, useQuery } from "convex-svelte";

// Add new state for progressive loading
let generatedPostId = $state<Id<"generated_posts"> | null>(null);

// Subscriptions using "skip" pattern for conditional queries
const postQuery = useQuery(
    api.generatedPosts.get, 
    () => generatedPostId ? { id: generatedPostId } : "skip"
);

const imagesQuery = useQuery(
    api.generatedImages.listByPost,
    () => generatedPostId ? { generatedPostId } : "skip"
);

// Derived states from subscriptions
let postData = $derived(postQuery.data);
let imagesData = $derived(imagesQuery.data ?? []);

// Progressive loading states
let isGeneratingCaption = $derived(postData?.status === "generating_caption");
let isGeneratingImages = $derived(postData?.status === "generating_images");
let isCompleted = $derived(postData?.status === "generated");
let caption = $derived(postData?.caption ?? "");
let pendingModels = $derived(postData?.pendingImageModels ?? []);
let totalModels = $derived(postData?.totalImageModels ?? selectedModels.length);
let hasAnyImage = $derived(imagesData.length > 0);
let hasCaption = $derived(caption.length > 0);

// Update generatedCaption/generatedImages for existing UI
$effect(() => {
    if (postData?.caption) {
        generatedCaption = postData.caption;
    }
});

$effect(() => {
    if (imagesData.length > 0) {
        generatedImages = imagesData.map(img => ({
            storageId: img.storageId,
            model: img.model,
            url: img.url,
            prompt: img.prompt,
            width: img.width,
            height: img.height,
        }));
    }
});
```

#### 4b. Update `handleGenerate` function

```typescript
async function handleGenerate() {
    if (!prompt.trim()) return;
    
    isGenerating = true;
    error = null;
    hasGenerated = false;
    generatedPostId = null; // Reset
    
    try {
        // Upload reference images (existing)
        let imageStorageIds: Id<"_storage">[] = [];
        if (referenceImages.length > 0) {
            const uploadPromises = referenceImages.map(img => uploadFileToStorage(img.file));
            imageStorageIds = await Promise.all(uploadPromises);
        }

        const attachments = imageStorageIds.length > 0 
            ? { imageStorageIds } 
            : undefined;

        // Call action - returns immediately with generatedPostId
        const result = await client.action(api.ai.chat.generate, {
            message: buildFullPrompt(),
            imageModels: selectedModels,
            aspectRatio,
            resolution,
            ...(attachments && { attachments }),
        });

        // Set ID to start subscriptions
        generatedPostId = result.generatedPostId;
        hasGenerated = true;
        
    } catch (err) {
        console.error("Generation failed:", err);
        error = err instanceof Error ? err.message : "Erro ao gerar conteudo";
        isGenerating = false;
    }
}
```

#### 4c. Update effect to track completion

```typescript
// Track when generation is complete
$effect(() => {
    if (isCompleted && generatedPostId) {
        isGenerating = false;
    }
});
```

#### 4d. Update UI states in template

Replace the loading/results section with progressive states:

```svelte
{#if error && !isGenerating}
    <!-- Error state (existing) -->

{:else if !hasGenerated && !isGenerating && !generatedPostId}
    <!-- Empty state (existing) -->

{:else if isGenerating && !generatedPostId}
    <!-- Initial loading - uploading references -->
    <div class="flex flex-1 flex-col items-center justify-center gap-4 p-8">
        <LoadingSpinner />
        <div class="text-center">
            <h3 class="text-lg font-medium">Iniciando geracao</h3>
            <p class="mt-2 text-xs text-muted-foreground">
                Preparando arquivos...
            </p>
        </div>
    </div>

{:else if generatedPostId && isGeneratingCaption}
    <!-- Caption loading -->
    <div class="flex flex-1 flex-col items-center justify-center gap-4 p-8">
        <LoadingSpinner />
        <div class="text-center">
            <h3 class="text-lg font-medium">Gerando legenda</h3>
            <p class="mt-2 text-xs text-muted-foreground">
                Criando uma legenda perfeita para seu post...
            </p>
        </div>
    </div>

{:else if generatedPostId && hasCaption}
    <!-- Results UI - show progressively -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Image section -->
        <div class="flex flex-1 flex-col border-r border-border">
            <div class="flex items-center justify-between border-b border-border bg-background px-4 py-3">
                <div class="flex items-center gap-2">
                    <h3 class="text-sm font-medium">Imagens Geradas</h3>
                    {#if !hasAnyImage}
                        <Badge variant="secondary">Gerando...</Badge>
                    {:else}
                        <Badge variant="secondary">{imagesData.length}/{totalModels}</Badge>
                    {/if}
                </div>
                <!-- ... existing buttons ... -->
            </div>
            
            <div class="flex flex-1 flex-col overflow-auto bg-muted/50">
                {#if !hasAnyImage}
                    <!-- No images yet - show all skeletons -->
                    <div class="grid grid-cols-2 gap-4 p-6">
                        {#each selectedModels as model}
                            <ImageSkeleton {model} aspectRatio={aspectRatio} />
                        {/each}
                    </div>
                {:else}
                    <!-- Show images + pending skeletons -->
                    <div class="flex flex-1 flex-col">
                        <!-- Main selected image (existing) -->
                        
                        <!-- Thumbnail strip with skeletons for pending -->
                        <div class="shrink-0 border-t border-border bg-background p-4">
                            <div class="flex justify-center gap-3">
                                {#each generatedImages as image, index}
                                    <!-- Existing thumbnail buttons -->
                                {/each}
                                {#each pendingModels as model}
                                    <ImageSkeleton {model} size="thumbnail" />
                                {/each}
                            </div>
                        </div>
                    </div>
                {/if}
            </div>
        </div>

        <!-- Caption section (existing, but shows immediately when ready) -->
    </div>
{/if}
```

### 5. Create ImageSkeleton Component

Create `src/lib/components/studio/ImageSkeleton.svelte`:

```svelte
<script lang="ts">
    import { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider } from "$lib/components/ui";
    
    interface Props {
        model?: string;
        aspectRatio?: string;
        size?: "full" | "thumbnail";
    }
    
    let { model, aspectRatio = "1:1", size = "full" }: Props = $props();
    
    // Model name mapping for display
    const modelDisplayNames: Record<string, string> = {
        "google/gemini-2.5-flash-image": "Nano Banana",
        "google/gemini-3-pro-image-preview": "Nano Banana Pro",
        "bytedance-seed/seedream-4.5": "SeeDream v4.5",
        "black-forest-labs/flux.2-flex": "Flux 2 Flex",
        "openai/gpt-5-image": "GPT Image 1.5",
    };
    
    let displayName = $derived(modelDisplayNames[model ?? ""] ?? model?.split("/").pop() ?? "");
    
    // Parse aspect ratio for styling
    let [w, h] = $derived(aspectRatio.split(":").map(Number));
</script>

<TooltipProvider>
    <Tooltip>
        <TooltipTrigger asChild>
            {#if size === "thumbnail"}
                <div 
                    class="group relative h-20 w-20 overflow-hidden border-2 border-dashed border-border bg-muted animate-pulse"
                >
                    <div class="absolute inset-0 flex flex-col items-center justify-center gap-1">
                        <svg class="h-4 w-4 animate-spin text-muted-foreground" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <div class="absolute inset-x-0 bottom-0 bg-black/70 px-1 py-0.5 text-center text-[10px] text-white opacity-0 transition-opacity group-hover:opacity-100">
                        {displayName}
                    </div>
                </div>
            {:else}
                <div 
                    class="relative overflow-hidden border border-dashed border-border bg-muted animate-pulse"
                    style="aspect-ratio: {w} / {h};"
                >
                    <div class="absolute inset-0 flex flex-col items-center justify-center gap-3">
                        <svg class="h-8 w-8 animate-spin text-muted-foreground" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        {#if model}
                            <span class="text-xs text-muted-foreground">{displayName}</span>
                        {/if}
                    </div>
                </div>
            {/if}
        </TooltipTrigger>
        <TooltipContent>
            <p>Nao se preocupe, isso leva alguns segundos</p>
        </TooltipContent>
    </Tooltip>
</TooltipProvider>
```

### 6. Export ImageSkeleton from studio index

Update `src/lib/components/studio/index.ts`:

```typescript
export { default as ImageSkeleton } from "./ImageSkeleton.svelte";
```

---

## Verification

1. `bun run check` - no TypeScript errors
2. `bunx convex dev --once` - deploy backend changes
3. Test generation flow:
   - [ ] Caption should appear within 5-10s
   - [ ] First image should appear 10-20s after caption
   - [ ] Remaining images fill in progressively
   - [ ] Skeletons show tooltip on hover
4. Test with multiple models selected
5. Test error handling (one model fails, others succeed)
6. Test page refresh during generation (should see current state)

---

## Edge Cases

| Case | Expected Behavior |
|------|-------------------|
| User navigates away | Subscriptions clean up automatically, action continues in background |
| All images fail | Show caption + "Nenhuma imagem foi gerada" |
| Network disconnect | Convex reconnects automatically, subscriptions resume |
| Page refresh mid-generation | Re-subscribe, see current state from DB |
| Caption generation fails | Show error, don't proceed to images |

---

## Order of Implementation

1. Schema changes (`schema.ts`)
2. Add `removeFromPending` mutation (`generatedPosts.ts`)
3. Update `create` and `updateFromChat` args (`generatedPosts.ts`)
4. Create `ImageSkeleton.svelte` component
5. Export from studio index
6. Restructure `generate` action (`chat.ts`)
7. Update frontend page (`+page.svelte`)
8. Test and verify
