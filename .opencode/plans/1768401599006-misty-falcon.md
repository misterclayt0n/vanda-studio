# Fix Image Generation: Use Direct OpenRouter API

## Problem

The current `ImageGeneration.ts` uses Vercel AI SDK's `generateText` with `@openrouter/ai-sdk-provider`, but:

1. **`@openrouter/ai-sdk-provider` does NOT have `.image()` method** - it only provides `chat()`, `completion()`, and `textEmbeddingModel()`
2. **Vercel AI SDK's `generateImage()` requires an `ImageModel`** - created via `provider.image(modelId)`
3. **OpenRouter returns images in `message.images[]`** - when using `generateText` with `modalities: ["image", "text"]`, the SDK doesn't expose this
4. **`response.body` is undefined** when using the SDK because it processes responses internally

The Vercel Labs [ai-sdk-image-generator](https://github.com/vercel-labs/ai-sdk-image-generator) example shows the correct pattern:
```typescript
import { experimental_generateImage as generateImage } from "ai";
import { openai } from "@ai-sdk/openai";
import { fireworks } from "@ai-sdk/fireworks";
import { replicate } from "@ai-sdk/replicate";
import { vertex } from "@ai-sdk/google-vertex/edge";

// Each provider has .image() method
const result = await generateImage({
  model: openai.image("dall-e-3"),  // or fireworks.image(), replicate.image(), etc.
  prompt,
  size: "1024x1024",
});

const base64 = result.image.base64;
```

## Solution

**Use direct `fetch()` to OpenRouter API** for image generation.

Why not switch to `@ai-sdk/fireworks` or `@ai-sdk/replicate`?
- Would require new API keys for each provider
- OpenRouter gives us access to many providers through one key
- OpenRouter's image generation works, we just need to call it correctly

OpenRouter's image generation works through the chat completions endpoint:
- URL: `https://openrouter.ai/api/v1/chat/completions`
- Body: `{ model, messages, modalities: ["image", "text"], image_config: {...} }`
- Response: `choices[0].message.images[].image_url.url` (base64 data URL)

## Files to Modify

- `src/convex/ai/llm/services/ImageGeneration.ts` - Replace SDK `generateText` with direct `fetch`

## Implementation

### Replace the generateImage implementation

```typescript
// BEFORE (broken - SDK doesn't expose image response)
const result = await generateText({
  model: openrouter.chat(model, {
    extraBody: { modalities: ["image", "text"], image_config: {...} },
  }),
  messages: [{ role: "user", content: contentParts }],
});

// AFTER (working - direct API call)
const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${apiKey}`,
    'Content-Type': 'application/json',
    'HTTP-Referer': siteUrl,
    'X-Title': 'Vanda Studio',
  },
  body: JSON.stringify({
    model,
    messages: [{ role: 'user', content: contentParts }],
    modalities: ['image', 'text'],
    image_config: {
      aspect_ratio: aspectRatio,  // "1:1", "16:9", etc.
      image_size: imageSize,      // "1K", "2K", "4K"
    },
  }),
});

if (!response.ok) {
  const error = await response.json();
  throw new ProviderError({ status: response.status, message: error.message });
}

const result = await response.json();

// Parse from the actual response
const imageData = result.choices?.[0]?.message?.images?.[0];
if (imageData?.image_url?.url) {
  const dataUrl = imageData.image_url.url;
  // dataUrl is "data:image/png;base64,..."
  return parseDataUrl(dataUrl);
}

throw new ImageGenerationError({ reason: "No image in response" });
```

### Keep existing helpers

- `fetchImageAsBase64()` - still needed for reference images
- `parseDataUrl()` - extract mimeType and base64 from data URL
- Error types and mapping

### Keep Effect wrapper

```typescript
generateImage: (params) =>
  Effect.tryPromise({
    try: async () => {
      const response = await fetch(...);
      // ... parse and return
    },
    catch: mapError,
  }),
```

## Message Format for Reference Images

For multimodal requests with reference images, use array content:
```typescript
const messages = [{
  role: 'user',
  content: [
    { type: 'image_url', image_url: { url: 'data:image/jpeg;base64,...' } },
    { type: 'text', text: 'Generate similar image with...' }
  ]
}];
```

## Model IDs (confirmed working on OpenRouter)

- `google/gemini-2.5-flash-image-preview` - Gemini Flash for images
- `black-forest-labs/flux-pro-1.1` - Flux Pro
- `black-forest-labs/flux-1.1-pro` - Flux 1.1 Pro
- `black-forest-labs/flux-schnell` - Flux Schnell (fast)

## Verification

1. `bunx convex dev --once` to deploy
2. Go to `/posts/create`
3. Enter prompt, select model(s), click Generate
4. Check Convex logs for:
   - `[IMAGE] Generating with model: ...`
   - `[IMAGE] Response status: 200`
   - `[IMAGE] Successfully parsed image`
5. Verify image appears in UI

## Error Handling

- Check `response.ok` before parsing
- Handle 429 (rate limit) → `RateLimitError`
- Handle 4xx/5xx → `ProviderError`
- Log response body on failure for debugging
